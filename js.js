$(document).ready(function(){var s,d=$("#payment-form"),p="",i="",c="",l="",_="Please specify a valid credit card number.",u="Invalid expiration date.",m="Invalid CVV/CVC.",f="This card is not supported",b="Powered by Epicor Payment Gateway",y=["VI","MC","AX","DS","DC","JC","UP"];let h=!1,v=!1;var o=!1,g="",C="",x=!1,k=!1,V=!1,w="hosted_payments_app_cardNumber";$("#hosted_payments_app_modal").on("hidden.bs.modal",function(){clearInterval(s);parent.postMessage({operation:"close",params:{}},"*")});function e(e){var r,a,t,c,n=(o=JSON.parse(e.data)).operation,o=o.params;e=e.origin,document.createElement("a").href=e,o.card_type_config&&o.card_type_config.allowed_payment_card_types&&(y=o.card_type_config.allowed_payment_card_types),C=g="","open"==n&&($("input[name=cardNumber]").val(""),$("input[name=cardCVC]").val(""),$("input[name=cardExpiry]").val(""),e="",o.style_config&&(n="",r=".custom-error { ",(a=o.style_config).err_font&&(r=r+"font-family:"+a.err_font+";"),a.err_font_size&&(r=r+"font-size:"+a.err_font_size+";"),a.err_font_color&&(r=r+"color:"+a.err_font_color+";"),r+="}",a.body_background&&(n=".custom-model-content {background: "+a.body_background+";} "),a.header_border&&(n=(n=(n+=".custom-modal-header { ")+"border-bottom:"+a.header_border+"; }")+".custom-modal-footer { border-top:"+a.header_border+"; }"),n+=".custom-form-control {",a.control_font&&(n=n+"font-family:"+a.control_font+";"),a.control_font_size&&(n=n+"font-size:"+a.control_font_size+";"),a.control_font_color&&(n=n+"color:"+a.control_font_color+";"),n=(a.control_background?n+"background:"+a.control_background+";":n)+"} .custom-btn {",t=".btn-success custom-btn {",a.btn_font&&(n=n+"font-family:"+a.btn_font+";"),a.btn_font_size&&(n=n+"font-size:"+a.btn_font_size+";"),a.btn_font_color&&(n=n+"color:"+a.btn_font_color+";",t=t+"color:"+a.btn_font_color+";"),a.btn_font_background&&(n=n+";background-color:"+a.btn_font_background+";",t=t+"background:"+a.btn_font_background+";"),e=n+="}"),e+=r,(a=document.createElement("style")).appendChild(document.createTextNode(e)),document.head.appendChild(a),o.namespace&&(p=o.namespace),o.public_key&&(i=o.public_key),"enable_card_profile"in o&&(h=!0,v=o.enable_card_profile),t="en_US",c=void(o.lang&&(t=o.lang)),o.translation_config&&(c=o.translation_config),d.validate().resetForm(),$.i18n.properties({name:"Messages",path:"bundle/",mode:"both",language:t,callback:function(){var e=$.i18n.prop("card_num_lbl"),r=$.i18n.prop("card_num_plh"),a=$.i18n.prop("card_date_lbl"),t=$.i18n.prop("card_expiration_plh"),n=$.i18n.prop("card_cvv_lbl"),o=$.i18n.prop("card_cvv_plh");_=$.i18n.prop("ccnum_err"),u=$.i18n.prop("expiry_err1"),m=$.i18n.prop("cvv_err"),f=$.i18n.prop("unsupported_card_err"),b=$.i18n.prop("branding_text"),c&&(c.ccnum_lbl&&(e=c.ccnum_lbl),c.ccnum_plh&&(r=c.ccnum_plh),c.expiry_lbl&&(a=c.expiry_lbl),c.expiry_plh&&(t=c.expiry_plh),c.cvv_lbl&&(n=c.cvv_lbl),c.cvv_phl&&(o=c.cvv_phl),c.ccnum_err&&(_=c.ccnum_err),c.expiry_err1&&(u=c.expiry_err1),c.cvv_err&&(m=c.cvv_err),c.unsupported_card_err&&(f=c.unsupported_card_err),c.branding_text)&&(b=c.branding_text),$("label[for=cardNumber]").text(e),$("input[name=cardNumber]").attr("placeholder",r),$("label[for=cardExpiry]").val("").text(a),$("input[name=cardExpiry]").attr("placeholder",t),$("label[for=cardCVC]").text(n),$("input[name=cardCVC]").attr("placeholder",o),$("#custom-branding-text").text(b)}}),o.name?$("#hosted_payments_app_title").text(o.name):$("#hosted_payments_app_title").text($.i18n.prop("hosted_payments_model_title")),o.button?$("#hosted_payments_app_button").html(o.button):$("#hosted_payments_app_button").html($.i18n.prop("hosted_payments_btn")),o.cancel_button?$("#hosted_payments_app_cancel_button").html(o.cancel_button):$("#hosted_payments_app_cancel_button").html($.i18n.prop("hosted_payments_app_cancel_button")),$("#hosted_payments_app_cardType").html('<i class="fa fa-credit-card"></i>'),s=setInterval(P,250),$("#hosted_payments_app_modal").modal({backdrop:"static"}))}function E(e,r){"card_name"in e&&("card_type"in e&&0!==e.card_type.length?(r.card_type=e.card_type,r.cardtype=e.card_type):"card_type"in e&&0===e.card_type.length&&(r.card_type=r.cardtype),r.card_type_desc=e.card_type_desc,r.card_name=e.card_name,r.pcl3_applicable=e.pcl3_applicable,r.surcharge_applicable=e.surcharge_applicable)}window.addEventListener?window.addEventListener("message",e):window.attachEvent&&window.attachEvent("onmessage",e),d.find(".subscribe").on("click",function(e){e.preventDefault(),x=!0;var r,a,e=t.form();C=g="",x=!1,e&&(d.find(".subscribe").html('Validating <i class="fa fa-spinner fa-pulse"></i>').prop("disabled",!0),e=$("input[name=cardNumber]").val().split(" ").join(""),r=$("input[name=cardCVC]").val(),a=$("input[name=cardExpiry]").val(),clearInterval(s),e={namespace:p,public_key:i,cardnumber:e,cvv:r,exp:a},h&&(e.enable_card_profile=v),$.ajax({url:"/hosted_token/",contentType:"application/json",data:JSON.stringify(e),type:"POST",success:function(e){var r,a,t,n,o={},o=e.success?(r=e.token.substr(e.token.length-4),a=e.token.substr(0,4)+((e,r)=>e.repeat?e.repeat(r):Array.apply(null,{length:r+1}).join(e).slice(0,r))("X",e.token.length-8)+r,t=c,(n={visa:"VI",mastercard:"MC",amex:"AX",discover:"DS",diners:"DC",dinersclub:"DC",jcb:"JC",maestro:"MC",unionpay:"UP"}).hasOwnProperty(c)&&(t=n[c]),e.expdate&&(l=e.expdate),{success:!0,token:e.token,transid:e.transid,lastfour:r,masked:a,cardtype:t,expdate:l,cvv:e.cvv}):{success:!1,error:"Request failed: "+e.message};h&&E(e,o),parent.postMessage({operation:"token",params:o},"*"),$("input[name=cardNumber]").val(""),$("input[name=cardCVC]").val(""),$("input[name=cardExpiry]").val("")},error:function(e){e={success:!1,error:"Request failed: "+e.status+" "+e.responseText};parent.postMessage({operation:"token",params:e},"*"),$("input[name=cardNumber]").val(""),$("input[name=cardCVC]").val(""),$("input[name=cardExpiry]").val("")}}))}),d.find(".subscribe-cancel").on("click",function(){clearInterval(s);parent.postMessage({operation:"close",params:{}},"*")});let N=get_payment_service("payform");N.format_card_number("input[name=cardNumber]"),N.format_cvv("input[name=cardCVC]"),N.format_expiry("input[name=cardExpiry]");var T=0,j=function(){return 1===T?f:_};function M(e){T=2;var r={visa:"VI",mastercard:"MC",amex:"AX",discover:"DS",diners:"DC",dinersclub:"DC",jcb:"JC",maestro:"MC",unionpay:"UP"};if(t=N.validate_card_number(e)){T=1;var a=N.get_card_type(e);c=a,$("#hosted_payments_app_cardType").html('<img height="20" width="32" alt="'+a+'" src="https://sce.toogo.io/hp/lib/images/'+a+'.png">');for(var t=!1,n=0;n<y.length;n++)if(y[n]==r[a]){t=!(T=0);break}}return t||$("#hosted_payments_app_cardType").html('<i class="fa fa-credit-card"></i>'),t}jQuery.validator.addMethod("cardNumber",function(e){var r,a,t,n;return!1===x&&!0===h||(h?(!1===(r=(e=>{if(!(11<e.length))return!1;if(!/^[0-9]*$/.test(e))return!1;if(g===e&&""!==C)$("#hosted_payments_app_cardType").html('<img height="20" width="32" alt="'+C+'" src="https://sce.toogo.io/hp/lib/images/'+C+'.png">');else{if(g===e&&""===C)return k=!0;V=!0}return!0})(n=(e+"").replace(/\s+|-/g,"")))&&(T=2,$("#hosted_payments_app_cardType").html('<i class="fa fa-credit-card"></i>')),k&&M(e),V&&(a=n,t={VI:"visa",MC:"mastercard",AX:"amex",DS:"discover",DC:"dinersclub",JC:"jcb",UP:"unionpay"},n=v,o=!!n&&["t","true","y","yes","on","1"].includes(n.toLowerCase()),n={cardnumber:a,namespace:p,public_key:i,enable_card_profile:o},$.ajax({url:"/card_profile/",contentType:"application/json",data:JSON.stringify(n),type:"POST",success:function(e){var r;e.success?(""!==e.card_profile.card_type&&(r=e.card_profile.card_type,void 0!==(r=t[c=r])&&D(!0,"success",a,r),void 0===r)&&D(!0,"undefined",a,r),""===e.card_profile.card_type&&D(!0,"empty",a)):D(!0,"unsuccessful",a)},error:function(e){D(!0,"error",a)}})),V=k=!1,r):h?void 0:M(e))},j);jQuery.validator.addMethod("cardExpiry",function(e,r){e=e.split(" ").join("").split("/");return l=e.join(""),this.optional(r)||1<e.length&&N.validate_card_expiry(e[0],e[1])},function(){return u});jQuery.validator.addMethod("cardCVC",function(e,r){return this.optional(r)||N.validate_card_cvc(e)},function(){return m});var t=d.validate({onfocusout:function(e,r){x=e.id===w,$.validator.defaults.onfocusout.call(this,e,r)},onkeyup:function(e,r){e.id===w&&(x=!1),$.validator.defaults.onkeyup.call(this,e,r)},rules:{cardNumber:{required:!0,cardNumber:!0},cardExpiry:{required:!0,cardExpiry:!0},cardCVC:{required:!0,cardCVC:!0}},highlight:function(e){$(e).closest(".form-control").removeClass("success").addClass("error")},unhighlight:function(e){$(e).closest(".form-control").removeClass("error").addClass("success")},errorPlacement:function(e,r){e.addClass("custom-error"),$(r).closest(".form-group").append(e),r.attr("id")===w&&$("#hosted_payments_app_cardType").html('<i class="fa fa-credit-card"></i>')}});function D(e,r,a,t){"success"===r&&($("#hosted_payments_app_cardType").html('<img height="20" width="32" alt="'+t+'" src="https://sce.toogo.io/hp/lib/images/'+t+'.png">'),T=0,g=a,C=t,$(n).closest(".form-control").removeClass("success").addClass("error")),"empty"!==r&&"undefined"!==r&&"unsuccessful"!==r&&"error"!==r||(c=C="",M(g=a));var t=j(),r=$("<label>"),n=(r.attr("id",w+"-error"),r.attr("class","error custom-error"),r.attr("for",w),r.attr("style",""),r.text(t),"#"+w),a=n+"-error";e&&($(n).closest(".form-control").removeClass("error").addClass("success"),$(a).attr("style","display: none;")),e||($(n).closest(".form-control").removeClass("success").addClass("error"),0===$(a).length&&$(n).closest(".form-group").append(r),$(a).text(t),$(a).show(),$("#hosted_payments_app_cardType").html('<i class="fa fa-credit-card"></i>'))}d.find(".subscribe").prop("disabled",!0);var P=function(){d.find(".subscribe").prop("disabled",!(d.find("[name=cardNumber]").hasClass("success")&&d.find("[name=cardExpiry]").hasClass("success")&&2<d.find("[name=cardCVC]").val().length))}});
